import{_ as i,c as e,o as s,a4 as t}from"./chunks/framework.Bl20_RFa.js";const a="/assets/scripts-scope.B5Fjuj0Q.svg",n="/assets/scripts-visibility.7N_r-fhL.svg",r="/assets/inspecting-scripts.B89lIHVT.png",f=JSON.parse('{"title":"Configure workflows to run sequences of commands in Stacks with Terramate Scripts","description":"Learn how to configure workflows to execute sequences of commands in stacks with Terramate Scripts.","frontmatter":{"title":"Configure workflows to run sequences of commands in Stacks with Terramate Scripts","description":"Learn how to configure workflows to execute sequences of commands in stacks with Terramate Scripts."},"headers":[],"relativePath":"cli/orchestration/scripts.md","filePath":"cli/orchestration/scripts.md"}'),o={name:"cli/orchestration/scripts.md"},l=t(`<h1 id="configure-and-run-workflows-with-terramate-scripts" tabindex="-1">Configure and run workflows with Terramate Scripts <a class="header-anchor" href="#configure-and-run-workflows-with-terramate-scripts" aria-label="Permalink to &quot;Configure and run workflows with Terramate Scripts&quot;">​</a></h1><p>Workflows are a way of combining multiple commands into one executable unit of work called Terramate Scripts.</p><h2 id="introduction" tabindex="-1">Introduction <a class="header-anchor" href="#introduction" aria-label="Permalink to &quot;Introduction&quot;">​</a></h2><p>When using Terramate CLI, you often encounter scenarios where you want to execute a sequence of commands in stacks. A typical sequence for a Terraform deployment is:</p><ul><li><code>terraform init</code></li><li><code>terraform validate</code></li><li><code>tfsec .</code></li><li><code>terraform apply -auto-approve</code></li></ul><p>This would typically require you to invoke multiple <code>terramate run</code> commands.</p><p>The following will execute each step in our defined workflow in stacks:</p><ul><li><code>terramate run terraform init</code></li><li><code>terramate run terraform validate</code></li><li><code>terramate run tfsec .</code></li><li><code>terramate run terraform apply -auto-approve</code></li></ul><p>Terramate CLI would first invoke <code>terraform init</code> in all stacks, then continue with <code>terraform validate</code>, and so on.</p><p>To run the full sequence of commands in each stack they could be executed in a shell:</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">terramate</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> sh</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -c</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  terraform init &amp;&amp;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  terraform validate &amp;&amp;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  tfsec . &amp;&amp;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  terraform apply -auto-approve</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &#39;</span></span></code></pre></div><p>The example above first executes all listed commands in the first stack before moving on to the next stack.</p><p>Terramate Scripts allow you to configure sequences of commands and execute them in a single call, e.g. <code>terramate script run</code>. You do not need to remember the sequence and can not forget a command, no matter if you run the script in CI/CD or on your local machine.</p><div class="info custom-block"><p class="custom-block-title">INFO</p><p>Terramate Scripts is a new and experimental feature that might still be subject to changes in the future. To use this feature it needs to be enabled explicitly in your Terramate config by adding it to <code>experiments</code>.</p><div class="language-hcl vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">hcl</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># terramate.tm.hcl</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  terramate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    config</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      experiments</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;scripts&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Enable Terramate Scripts</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div></div><h2 id="defining-scripts" tabindex="-1">Defining scripts <a class="header-anchor" href="#defining-scripts" aria-label="Permalink to &quot;Defining scripts&quot;">​</a></h2><p>A script in Terramate CLI is defined in a script block placed in any Terramate configuration file on any level of your project hierarchy. The <code>script</code> block has the following syntax:</p><div class="language-hcl vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">hcl</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">script</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> &quot;command&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> &quot;subcommand&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># any level of subcommands is supported</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  description</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Execute commands&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  job</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    commands</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;echo&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;-n&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Hello&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;echo&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot; World!&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><ul><li><p>The list of labels of the <code>script</code> block defines the arguments you need to provide to the <code>terramate script run</code> command in order to execute the script: <code>terramate script run command subcommand</code>. You can define any number of labels.</p></li><li><p>Attributes and Blocks Reference of the <code>script</code> block</p><ul><li><p><code>name</code> <em>(optional)</em> - A name for the jobs being executed (maximum of 128 chars)</p></li><li><p><code>description</code> <em>(required)</em> - A description of the jobs being executed</p></li><li><p><code>job</code> <em>(required)</em> - One or more blocks each defining a sequence of commands to be executed in the script. Jobs are executed in the order of definition.</p><p>Each job can have the following attributes:</p><ul><li><code>commands</code> <em>(required)</em> - A list of commands. Each item is a list that has the form <code>[ command, arg1, arg2, ...]</code> that will be executed accordingly. Terramate Functions and variable interpolation of the following namespaces is supported: <code>global</code>, <code>terramate</code>, and <code>env</code> Optionally, the last item of the argument list can be an object containing Terramate-specific options for this command. In this case, the form is extended to <code>[ command, arg1, arg2, ..., {option1: value1, option2: value2} ]</code>. See below for a list of supported command options.</li></ul></li></ul></li></ul><p>To run a Terraform deployment, a script can be defined as:</p><div class="language-hcl vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">hcl</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">script</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> &quot;deploy&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  description</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Run a Terraform deployment&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  job</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    commands</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;terraform&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;init&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;terraform&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;validate&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;tfsec&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;.&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;terraform&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;apply&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;-auto-approve&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="command-options" tabindex="-1">Command options <a class="header-anchor" href="#command-options" aria-label="Permalink to &quot;Command options&quot;">​</a></h3><ul><li><code>cloud_sync_deployment</code> <em>(optional boolean)</em> Send information about the deployment to Terramate Cloud. See <a href="./../cmdline/run#sending-deployment-data-to-terramate-cloud">Sending deployment data to Terramate Cloud</a>. Only one command per script may have this option set to true.</li><li><code>cloud_sync_drift_status</code> <em>(optional boolean)</em> Send drift information to Terramate Cloud. See <a href="./../cmdline/run#detecting-drift">Detecting Drifts</a>.</li><li><code>cloud_sync_terraform_plan_file</code> <em>(optional string)</em> Sync a Terraform plan file to Terramate Cloud with a deployment or drift. This option is only used when <code>cloud_sync_deployment</code> or <code>cloud_sync_drift_status</code> are set to true.</li></ul><h2 id="running-scripts" tabindex="-1">Running Scripts <a class="header-anchor" href="#running-scripts" aria-label="Permalink to &quot;Running Scripts&quot;">​</a></h2><p>Terramate scripts are run with <code>terramate script run &lt;command...&gt;</code>. This will execute the defined jobs commands in the context of each stack directory. Scripts can be defined on any level of the hierarchy, and follow the inheritance rules of Globals and other Terramate features. When calling a script it will only be executed on stacks that define or inherited the script definition and that are reachable from the current working directory and not affected by any filters. Scripts can be redefined on any level of the hierarchy and replace the previous definition.</p><div class="info custom-block"><p class="custom-block-title">INFO</p><p><strong>Note:</strong> No error or warning will be issued for stacks not selected for script execution.</p></div><p>A more detailed explanation is covered in the Scope and Visibility sections where:</p><ul><li>Scope defines where a script will be executed in</li><li>Visibility describes where a script can be called from</li></ul><h3 id="scope" tabindex="-1">Scope <a class="header-anchor" href="#scope" aria-label="Permalink to &quot;Scope&quot;">​</a></h3><p>In general, the scope of a script definition includes the directory it is defined in and all nested sub-directories. A script can be run on stacks within its scope.</p><p><strong>Figure A</strong> shows an example by highlighting the scope of a script named <code>cmd</code>:</p><img src="`+a+'" width="600px" alt="Shows an example by highlighting the scope of a script named"><p>Which stacks are selected further depends on additional criteria. Most importantly, the directory <code>terramate script run</code> is executed from, limits the selected stacks to those contained within. This works just like <code>terramate run</code>.</p><p>A useful property of scripts is that they allow multiple definitions with the same name at different locations, yet all can be run with a single <code>terramate script run</code> invocation. For example, as shown in in <strong>Figure B</strong>, <code>terramate script run cmd</code> at the root level will run each of the two script definitions on stacks within their respective scopes.</p><p>As shown in <strong>Figure C</strong>, a script that is re-defined in a sub-directory overriding its previous definition will only be executed in stacks contained within the sub-directory, while the other stacks execute the original definition of the script.</p><p>This behavior enables scenarios where a single <code>terramate script run deploy</code> could execute different scripts for different parts of the infrastructure, based on directory grouping.</p><h3 id="visibility" tabindex="-1">Visibility <a class="header-anchor" href="#visibility" aria-label="Permalink to &quot;Visibility&quot;">​</a></h3><p>To be able to call a script, it needs to be visible to the current working directory. Scripts are generally visible within their scope, as defined in the last section, but additionally, they are also visible to all their parent directories. This enables us to call a script from the project root without knowing where it is actually defined as also shown in <strong>Figure D</strong>.</p><img src="'+n+'" width="600px" alt="Explaining the visibility of a script in Terramate"><h2 id="inspecting-scripts" tabindex="-1">Inspecting Scripts <a class="header-anchor" href="#inspecting-scripts" aria-label="Permalink to &quot;Inspecting Scripts&quot;">​</a></h2><p>To inspect the behavior of a script, a dry-run can be started with <code>script run --dry-run &lt;command...&gt;</code>. This will print out the commands that would be executed per stack, without actually executing them.</p><p>Besides this, there are additional experimental commands that can be used to inspect and debug script definitions:</p><ul><li><a href="./../cmdline/script/script-list"><code>terramate script list</code></a> Shows a list of all uniquely named scripts that are visible in the current directory, their description, and the root directory of their scope. If there are multiple definitions with the same name, a parent is selected over a child, or a first sibling over a later sibling (ordered by directory name).</li><li><a href="./../cmdline/script/script-info"><code>terramate script info &lt;scriptname&gt;</code></a> Shows a detailed list of definitions for a given script name. This list includes the jobs and the stacks within the scope of each definition. As with the command before, this information is always relative to the current directory.</li><li><a href="./../cmdline/script/script-tree"><code>terramate script tree</code></a> Shows a tree view of all scripts relative to the current directory. The tree expands all sub-directories, and the parent path back to the project root, showing script definitions per directory. Example:</li></ul><img src="'+r+'" width="300px" alt="Explaining how to inspect scripts in Terramate"><ul><li>🟡 * Script definition (new or override)</li><li>⚪ ~ Script definition inherited from the parent scope</li><li>🟢 # Stack</li></ul>',44),p=[l];function c(h,d,k,u,m,g){return s(),e("div",null,p)}const y=i(o,[["render",c]]);export{f as __pageData,y as default};
