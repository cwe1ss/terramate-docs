import{_ as s,c as a,o as i,a4 as e}from"./chunks/framework.Bl20_RFa.js";const u=JSON.parse('{"title":"terramate run - Command","description":"Execute any commands in all stacks or in a filtered subset of stacks by using the `terramate run` command.","frontmatter":{"title":"terramate run - Command","description":"Execute any commands in all stacks or in a filtered subset of stacks by using the `terramate run` command.","outline":[2,3]},"headers":[],"relativePath":"cli/cmdline/run.md","filePath":"cli/cmdline/run.md"}'),t={name:"cli/cmdline/run.md"},n=e(`<h1 id="run-any-commands-in-stacks" tabindex="-1">Run any Commands in Stacks <a class="header-anchor" href="#run-any-commands-in-stacks" aria-label="Permalink to &quot;Run any Commands in Stacks&quot;">​</a></h1><h2 id="overview" tabindex="-1">Overview <a class="header-anchor" href="#overview" aria-label="Permalink to &quot;Overview&quot;">​</a></h2><p>The <code>terramate run</code> command executes <strong>any command</strong> in all or a subset of stacks honoring the defined <a href="./../orchestration/">order of execution</a>. Commands can be executed sequentially or in parallel.</p><p>When running commands you can filter for a specific subset of stacks such as:</p><ul><li>Stacks that have changed in the current branch or since the last merge (git-based filtering).</li><li>Stacks with or without specific tags are set in configuration.</li><li>Stacks in a subtree of the repository.</li><li>Stacks with a specific health status as known by Terramate Cloud, e.g. <code>drifted</code> or <code>failed</code> stacks.</li></ul><p>For details on how the change detection and order of execution works in Terramate please see:</p><ul><li><a href="./../change-detection/">Change Detection</a></li><li><a href="./../orchestration/">Orchestration</a></li></ul><h2 id="examples" tabindex="-1">Examples <a class="header-anchor" href="#examples" aria-label="Permalink to &quot;Examples&quot;">​</a></h2><h3 id="run-in-all-stacks" tabindex="-1">Run in all stacks <a class="header-anchor" href="#run-in-all-stacks" aria-label="Permalink to &quot;Run in all stacks&quot;">​</a></h3><p>When running <code>terramate run</code> without any options, the given command will be executed in all stacks reachable from the current workdir.</p><p>First, initialize Terraform in all stacks, then run <code>terraform apply</code> in all stacks.</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">terramate</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> terraform</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> init</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">terramate</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> terraform</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> apply</span></span></code></pre></div><h3 id="run-in-opposite-order" tabindex="-1">Run in opposite order <a class="header-anchor" href="#run-in-opposite-order" aria-label="Permalink to &quot;Run in opposite order&quot;">​</a></h3><p>To reverse the order of execution you can use <code>--reverse</code> option.</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">terramate</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --reverse</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> terraform</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> destroy</span></span></code></pre></div><h3 id="run-in-a-subtree" tabindex="-1">Run in a subtree <a class="header-anchor" href="#run-in-a-subtree" aria-label="Permalink to &quot;Run in a subtree&quot;">​</a></h3><p>To select a subtree within a repository, the <code>--chdir</code> global option can be set.</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">terramate</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --chdir</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> stacks/aws</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> terraform</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> init</span></span></code></pre></div><h3 id="run-in-changed-stacks" tabindex="-1">Run in changed stacks <a class="header-anchor" href="#run-in-changed-stacks" aria-label="Permalink to &quot;Run in changed stacks&quot;">​</a></h3><p>Stacks <a href="./../change-detection/">containing changes</a> can be selected with the <code>--changed</code> flag. This flag is also supported in <code>terramate list</code> which can be used to preview the affected stacks in advance.</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">terramate</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --changed</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> terraform</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> init</span></span></code></pre></div><h3 id="run-in-tagged-stacks" tabindex="-1">Run in tagged stacks <a class="header-anchor" href="#run-in-tagged-stacks" aria-label="Permalink to &quot;Run in tagged stacks&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">terramate</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --tags</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> k8s:prd</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> diff</span></span></code></pre></div><h3 id="tmc-deploy-changed-stacks" tabindex="-1">TMC: Deploy changed Stacks <a class="header-anchor" href="#tmc-deploy-changed-stacks" aria-label="Permalink to &quot;TMC: Deploy changed Stacks&quot;">​</a></h3><p>In order to track deployments and get notified about deployment status in Slack, you need to enable synchronization of the deployment status and details to Terramate Cloud (TMC).</p><p>The following example runs 5 stacks in parallel, selects only recently changed stacks and synchronizes the results to Terramate Cloud (TMC).</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># initialize changed stacks</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">terramate</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --changed</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --parallel</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 5</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  terraform</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> init</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># create a preview plan</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">terramate</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --changed</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --parallel</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 5</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  terraform</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> plan</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -lock-timeout=5m</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -out</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> out.tfplan</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># run the deployment</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">terramate</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --changed</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --parallel</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 5</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  --cloud-sync-deployment</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  --cloud-sync-terraform-plan-file=out.tfplan</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  --</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  terraform</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> apply</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -input=false</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -auto-approve</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -lock-timeout=5m</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> out.tfplan</span></span></code></pre></div><p>Deployments can also be executed the same way without synchronizing the details to Terramate Cloud. In this case, Terramate Cloud offers the following benefits:</p><ul><li>Get notified in Slack and tag involved team members.</li><li>Create an Alert and auto-assign ownership on deployment failure to keep the team responsible.</li><li>Keep track of deployment history, frequency and stack health.</li><li>Keep track of deployed resources and the historic evolution of your stacks.</li><li>Share deployment logs even when not executed in CI/CD but on local machines.</li><li>See deployment logs per stack instead of unreadable logs when running stacks in parallel.</li></ul><h3 id="tmc-detect-drifts" tabindex="-1">TMC: Detect Drifts <a class="header-anchor" href="#tmc-detect-drifts" aria-label="Permalink to &quot;TMC: Detect Drifts&quot;">​</a></h3><p>In order to detect drifts and get notified about detected drifts in Slack, you need to enable synchronization of drift status and details to Terramate Cloud (TMC):</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># initialize all stacks</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">terramate</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --parallel</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 5</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\\\</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  terraform</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> init</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># run the actual drift detection</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">terramate</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --parallel</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 5</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  --cloud-sync-drift-status</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  --cloud-sync-terraform-plan-file=drift.tfplan</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  --</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  terraform</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> plan</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -out</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> drift.tfplan</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -detailed-exitcode</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -lock=false</span></span></code></pre></div><p>Drifts can also be executed the same way without synchronizing the details to Terramate Cloud.</p><p>In this case, Terramate Cloud offers the following benefits:</p><ul><li>Get notified in Slack when a new drift is detected in a stack.</li><li>Create an Alert and auto-assign ownership on the detected drift to keep the team responsible.</li><li>Keep track of drift history, frequency and stack health.</li><li>Keep track of drifted resources and the historic evolution of your stacks.</li><li>Never miss a drift again when running the drift detection on a schedule in your CI/CD automation.</li><li>Automatic drift reconciliation (see the following example)</li><li>Automatic healing of stacks when a drift gets resolved via a deployment or manual.</li></ul><h3 id="tmc-auto-reconcile-drifts" tabindex="-1">TMC: Auto reconcile Drifts <a class="header-anchor" href="#tmc-auto-reconcile-drifts" aria-label="Permalink to &quot;TMC: Auto reconcile Drifts&quot;">​</a></h3><p>To auto-reconcile drifts, three things are needed:</p><ul><li><strong>Drift Detection is run</strong> regularly and detected drifts are synchronized to Terramate Cloud (TMC)</li><li><strong>Stacks are tagged</strong> to participate in auto reconciliation of drifts <em>(it is not recommended to reconcile just any stack due to the blast radius of potential destructive operations)</em></li><li><strong>Automation is set up</strong> to run drift detection and reconciliation scheduled in automation like GitHub Actions.</li></ul><p>The command can be tested locally by executing:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">terramate</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --cloud-status</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> drifted</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --tags</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> auto-reconcile-drift</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> terraform</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> apply</span></span></code></pre></div><h2 id="usage" tabindex="-1">Usage <a class="header-anchor" href="#usage" aria-label="Permalink to &quot;Usage&quot;">​</a></h2><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">terramate</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [options] -- </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">cmd ...</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span></span></code></pre></div><p><code>[options]</code> can be one or multiple of the following options:</p><h2 id="options" tabindex="-1">Options <a class="header-anchor" href="#options" aria-label="Permalink to &quot;Options&quot;">​</a></h2><h3 id="influence-orchestration" tabindex="-1">Influence orchestration <a class="header-anchor" href="#influence-orchestration" aria-label="Permalink to &quot;Influence orchestration&quot;">​</a></h3><ul><li><p><code>--continue-on-error</code></p><p>Do not stop execution when an error occurs.</p></li><li><p><code>--no-recursive</code></p><p>Do not recurse into nested child stacks. If executed in a non-stack directory, no stacks will be run.</p></li><li><p><code>--dry-run</code></p><p>Plan the execution but do not execute it.</p></li><li><p><code>--reverse</code></p><p>Reverse the order of execution.</p></li><li><p><code>--parallel &lt;n&gt;</code>, <code>-j &lt;n&gt;</code></p><p>Run independent stacks in parallel.</p></li><li><p><code>--disable-safeguards &lt;types&gt;</code>, <code>-</code>X\` A comma-separated list of safeguards.</p><p>This option can be used multiple times.</p><p>Disable safeguards. <code>-X</code> is short for disabling <code>all</code> safeguards.</p><p><code>&lt;types&gt;</code> can be one or multiple of:</p><ul><li><code>all</code> - Disable all safeguards. Use <code>-X</code> as a shorthand for this.</li><li><code>none</code> - Enable all safeguards if disabled by config or environment variable.</li><li><code>git</code> - Disable all <code>git</code>-based safeguards <ul><li><code>git-untracked</code> - Disable safeguarding against untracked files.</li><li><code>git-uncommitted</code> - Disable safeguarding against uncommitted changes.</li><li><code>git-out-of-sync</code> - Disable safeguarding against being out of sync with the remote default git branch.</li></ul></li><li><code>outdated-code</code> - Disable safeguarding against outdated code generation</li></ul><p>Safeguards can also be permanently or temporarily disabled via</p><ul><li>Terramate Configuration <code>terramate.config.run.disable_safeguard = &quot;&lt;types&gt;&quot;</code></li><li>Environment variable <code>TM_DISABLE_SAFEGUARDS=&lt;types&gt;</code></li></ul></li></ul><h3 id="interpolated-command-execution" tabindex="-1">Interpolated command execution <a class="header-anchor" href="#interpolated-command-execution" aria-label="Permalink to &quot;Interpolated command execution&quot;">​</a></h3><ul><li><p><code>--eval</code></p><p>Evaluate command arguments as HCL strings interpolating Globals, Functions and Metadata.</p></li></ul><h3 id="change-detection-support" tabindex="-1">Change detection support <a class="header-anchor" href="#change-detection-support" aria-label="Permalink to &quot;Change detection support&quot;">​</a></h3><ul><li><p><code>--changed</code>, <code>-c</code></p><p>Filter stacks based on changes made in git.</p><p>Example:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">terramate</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --changed</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> terraform</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> init</span></span></code></pre></div></li><li><p><code>--git-change-base &lt;ref&gt;</code>, <code>-B &lt;ref&gt;</code></p><p>Set git base reference for computing changes.</p><p>Can only be used when change detection is enabled via the <code>--changed</code> option.</p><p>Example:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">terramate</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --changed</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --git-change-base</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> HEAD~2</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> terraform</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> init</span></span></code></pre></div></li></ul><h3 id="filters-for-stacks" tabindex="-1">Filters for stacks <a class="header-anchor" href="#filters-for-stacks" aria-label="Permalink to &quot;Filters for stacks&quot;">​</a></h3><ul><li><p><code>--tags &lt;tags&gt;</code></p><p>Filter stacks by tags.</p></li><li><p><code>--no-tags &lt;tags&gt;</code></p><p>Filter stacks by tags not being set.</p></li></ul><h2 id="terramate-cloud-options" tabindex="-1">Terramate Cloud Options <a class="header-anchor" href="#terramate-cloud-options" aria-label="Permalink to &quot;Terramate Cloud Options&quot;">​</a></h2><h3 id="tmc-advanced-filters" tabindex="-1">TMC: Advanced filters <a class="header-anchor" href="#tmc-advanced-filters" aria-label="Permalink to &quot;TMC: Advanced filters&quot;">​</a></h3><ul><li><p><code>--cloud-status &lt;status&gt;</code> is only available when connected to Terramate Cloud.</p><p>Filter by Terramate Cloud (TMC) status of the stack.</p></li></ul><h3 id="tmc-deployment-synchronization" tabindex="-1">TMC: Deployment Synchronization <a class="header-anchor" href="#tmc-deployment-synchronization" aria-label="Permalink to &quot;TMC: Deployment Synchronization&quot;">​</a></h3><ul><li><p><code>--cloud-sync-deployment</code> is only available when connected to Terramate Cloud.</p><p>Synchronize the command as a new deployment to Terramate Cloud (TMC).</p><p>For Terraform deployments <code>--cloud-sync-terraform-plan-file &lt;plan-file&gt;</code> should always be added to include Terraform plan details when synchronizing.</p></li></ul><h3 id="tmc-drift-synchronization" tabindex="-1">TMC: Drift Synchronization <a class="header-anchor" href="#tmc-drift-synchronization" aria-label="Permalink to &quot;TMC: Drift Synchronization&quot;">​</a></h3><ul><li><p><code>--cloud-sync-drift-status</code> is only available when connected to Terramate Cloud.</p><p>Synchronize the command as a new drift run to Terramate Cloud (TMC).</p><p>For Terraform drift runs <code>--cloud-sync-terraform-plan-file &lt;plan-file&gt;</code> should always be added to include Terraform plan details when synchronizing.</p></li></ul><h3 id="tmc-preview-synchronization" tabindex="-1">TMC: Preview Synchronization <a class="header-anchor" href="#tmc-preview-synchronization" aria-label="Permalink to &quot;TMC: Preview Synchronization&quot;">​</a></h3><ul><li><p><code>--cloud-sync-preview</code> is only available when connected to Terramate Cloud.</p><p>Synchronize the command as a new preview to Terramate Cloud (TMC).</p><p>For Terraform previews <code>--cloud-sync-terraform-plan-file &lt;plan-file&gt;</code> is required to include Terraform plan details when synchronizing.</p></li><li><p><code>--cloud-sync-layer &lt;layer&gt;</code></p><p>Default <code>&lt;layer&gt;</code> is <code>default</code> when not set or not detected otherwise.</p><p>Set a custom layer for synchronizing a preview via <code>--cloud-sync-preview</code> to Terramate Cloud.</p></li></ul><h3 id="tmc-terraform-plan-synchronization" tabindex="-1">TMC: Terraform Plan Synchronization <a class="header-anchor" href="#tmc-terraform-plan-synchronization" aria-label="Permalink to &quot;TMC: Terraform Plan Synchronization&quot;">​</a></h3><ul><li><p><code>--cloud-sync-terraform-plan-file &lt;plan-file&gt;</code> is only available when connected to Terramate Cloud.</p><p>Add details of the Terraform Plan file to the synchronization to Terramate Cloud (TMC).</p><p>This flag is supported in combination with <code>--cloud-sync-drift-status</code>, <code>--cloud-sync-preview</code>, and <code>--cloud-sync-preview</code>.</p></li></ul><h2 id="configuration-of-the-run-command" tabindex="-1">Configuration of the Run Command <a class="header-anchor" href="#configuration-of-the-run-command" aria-label="Permalink to &quot;Configuration of the Run Command&quot;">​</a></h2><p>The <code>terramate</code> block at the project root can be used to customize the default exported environment variables in the <a href="./../projects/configuration#the-terramateconfigrunenv-block">terramate.config.run.env</a>.</p><p>It&#39;s also possible to set a different <code>PATH</code> environment variable and in this case, Terramate will honor it when looking up the program&#39;s absolute path.</p><p>For example, let&#39;s say you have a <code>bin</code> directory at the root of the Terramate project where you define some scripts that should be run in each stack.</p><p>In this case, you can have the declaration below in the root directory:</p><div class="language-hcl vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">hcl</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">terramate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  config</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    run</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      env</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        # prepend the bin/ directory so it has preference.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        PATH</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">terramate</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">root</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">path</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">fs</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">absolute</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/bin:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">env</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">PATH</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>Then if you have the script <code>bin/deploy-terraform.sh</code>, you can do:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> terramate</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> deploy-terraform.sh</span></span></code></pre></div><h2 id="terramate-cloud-specifics" tabindex="-1">Terramate Cloud specifics <a class="header-anchor" href="#terramate-cloud-specifics" aria-label="Permalink to &quot;Terramate Cloud specifics&quot;">​</a></h2><p>The run command offers extended functionality for Terramate Cloud users. For these commands to work <code>terramate</code> must be successfully authenticated with Terramate Cloud. This can be done locally with the <a href="./cloud/cloud-login">cloud login</a> command or by creating a trust relationship with Github. In the latter case, you must export the <code>GITHUB_TOKEN</code> in the Github action:</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">permissions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  id-token</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">write</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # (necessary for GITHUB_TOKEN to work)</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">env</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  GITHUB_TOKEN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">\${{ github.token }}</span></span></code></pre></div><h3 id="running-a-command-on-stacks-with-specific-cloud-status" tabindex="-1">Running a command on stacks with specific cloud status. <a class="header-anchor" href="#running-a-command-on-stacks-with-specific-cloud-status" aria-label="Permalink to &quot;Running a command on stacks with specific cloud status.&quot;">​</a></h3><p>It&#39;s possible to run commands in stacks with specific cloud status.</p><p>For example, for applying all stacks with the <code>drifted</code> status, the command below can be used:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> terramate</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --cloud-status=drifted</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> terraform</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> apply</span></span></code></pre></div><p>Valid statuses are documented on the <a href="./experimental/experimental-trigger">trigger page</a>.</p><h3 id="sending-deployment-data-to-terramate-cloud" tabindex="-1">Sending deployment data to Terramate Cloud <a class="header-anchor" href="#sending-deployment-data-to-terramate-cloud" aria-label="Permalink to &quot;Sending deployment data to Terramate Cloud&quot;">​</a></h3><p>The <code>--cloud-sync-deployment</code> flag will send information about the deployment to Terramate Cloud.</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">jobs</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  deploy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Deploy</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Apply changes</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">apply</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        run</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">terramate run --changed --cloud-sync-deployment -- terraform apply -input=false -auto-approve</span></span></code></pre></div><h3 id="sending-a-pull-request-preview-to-terramate-cloud" tabindex="-1">Sending a pull request preview to Terramate Cloud <a class="header-anchor" href="#sending-a-pull-request-preview-to-terramate-cloud" aria-label="Permalink to &quot;Sending a pull request preview to Terramate Cloud&quot;">​</a></h3><p>The <code>--cloud-sync-preview</code> flag will send information about the preview to Terramate Cloud.</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">jobs</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  preview</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Preview</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Run preview</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">preview</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        run</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">          terramate run \\</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">          --changed \\</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">          --cloud-sync-preview \\</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">          --cloud-sync-terraform-plan-file=preview.tfplan \\</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">          -- \\</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">          terraform plan -out preview.tfplan -detailed-exitcode</span></span></code></pre></div><h3 id="detecting-drift" tabindex="-1">Detecting Drift <a class="header-anchor" href="#detecting-drift" aria-label="Permalink to &quot;Detecting Drift&quot;">​</a></h3><p>The <code>run</code> command supports <code>--cloud-sync-drift-status</code> which will set the Terramate Cloud status of any stack to <code>drifted</code> <em>if the exit code of the command that is run is <code>2</code></em> (which for <code>terraform plan -detailed-exitcode</code> signals that the plan succeeded and there was a diff). Terramate is also able to send the drifted plan with the <code>--cloud-sync-terraform-plan-file</code> option. A typical Github action for drift detection would look something like this:</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Check drift on all stacks once a day</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  schedule</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">cron</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;0 2 * * *&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">jobs</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  drift-detect</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Check Drift</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    permissions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      id-token</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">write</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # necessary for GITHUB_TOKEN to work</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    env</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      GITHUB_TOKEN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">\${{ github.token }}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    steps</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      ...</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      initial setup steps</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Run drift detection</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">drift</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        run</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">          terramate run --cloud-sync-drift-status --cloud-sync-terraform-plan-file=drift.tfplan -- terraform plan -out drift.tfplan -detailed-exitcode</span></span></code></pre></div>`,88),l=[n];function h(p,r,o,d,k,c){return i(),a("div",null,l)}const y=s(t,[["render",h]]);export{u as __pageData,y as default};
